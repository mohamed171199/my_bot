<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ATLAM - تقييم SIRI (تجريبي)</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 16px; background: #fafafa; }
    h1 { margin-top: 0; }
    .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 12px; }
    .opt { display: block; margin: 6px 0; }
    button { padding: 10px 16px; background: #0f766e; color: #fff; border: none; border-radius: 8px; cursor: pointer; }
    .row { display: flex; gap: 8px; align-items: center; }
    .muted { color: #64748b; font-size: 0.9em; }
    .pill { display: inline-block; background: #e2e8f0; padding: 2px 10px; border-radius: 999px; margin-left: 4px; }
    .score { font-weight: bold; }
  </style>
  <script>
    let sessionId = null;
    let questions = [];
    let idx = 0;

    async function start() {
      const s = await fetch('/siri/start', { method: 'POST' }).then(r => r.json());
      sessionId = s.session_id;
      questions = await fetch('/siri/questions').then(r => r.json());
      idx = 0;
      render();
    }

    function render() {
      const app = document.getElementById('app');
      app.innerHTML = '';
      if (!sessionId) {
        const c = document.createElement('div'); c.className = 'card';
        c.innerHTML = '<h2>ابدأ التقييم</h2><p class="muted">إصدار تجريبي لأغراض الاختبار. لتنتج نتائج دقيقة، استبدل الأسئلة بأخرى متوافقة مع منهجية SIRI الرسمية.</p><button onclick="start()">ابدأ الآن</button>';
        app.appendChild(c);
        return;
      }
      if (idx >= questions.length) {
        showResult();
        return;
      }
      const q = questions[idx];
      const c = document.createElement('div'); c.className = 'card';
      c.innerHTML = `<h3>${q.text}</h3>`;
      q.options.forEach(o => {
        const lab = document.createElement('label');
        lab.className = 'opt';
        lab.innerHTML = `<input type="radio" name="opt" value="${o.score}"> ${o.text} <span class="muted">(درجة ${o.score})</span>`;
        c.appendChild(lab);
      });
      const btn = document.createElement('button'); btn.textContent = 'التالي';
      btn.onclick = async () => {
        const chosen = document.querySelector('input[name=opt]:checked');
        if (!chosen) { alert('اختر إجابة'); return; }
        const score = parseFloat(chosen.value);
        await fetch('/siri/answer', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ session_id: sessionId, question_id: q.id, score }) });
        idx += 1; render();
      };
      c.appendChild(btn);
      app.appendChild(c);
      const prog = document.createElement('div'); prog.className = 'muted'; prog.textContent = `سؤال ${idx + 1} من ${questions.length}`;
      app.appendChild(prog);
    }

    async function showResult() {
      const data = await fetch(`/siri/result?session_id=${sessionId}`).then(r => r.json());
      const app = document.getElementById('app');
      const c = document.createElement('div'); c.className = 'card';
      c.innerHTML = `<h2>النتيجة الإجمالية: <span class="score">${data.overall_score}</span> / 5</h2>`;
      app.appendChild(c);
      const dims = document.createElement('div'); dims.className = 'card';
      dims.innerHTML = '<h3>نتائج الأبعاد</h3>';
      data.dimensions.forEach(d => {
        const p = document.createElement('div');
        p.innerHTML = `<span class="pill">${d.pillar}</span> ${d.dimension_name}: <strong>${d.score}</strong>`;
        dims.appendChild(p);
      });
      app.appendChild(dims);
      const pil = document.createElement('div'); pil.className = 'card';
      pil.innerHTML = '<h3>نتائج الركائز</h3>';
      data.pillars.forEach(p => {
        const el = document.createElement('div'); el.innerHTML = `${p.pillar}: <strong>${p.score}</strong>`; pil.appendChild(el);
      });
      app.appendChild(pil);
      const rec = document.createElement('div'); rec.className = 'card';
      rec.innerHTML = '<h3>توصيات أولية</h3>';
      if ((data.recommendations || []).length === 0) rec.innerHTML += '<div class="muted">لا توجد توصيات تلقائية</div>';
      (data.recommendations || []).forEach(r => { const el = document.createElement('div'); el.textContent = r; rec.appendChild(el); });
      app.appendChild(rec);
      const again = document.createElement('button'); again.textContent = 'بدء تقييم جديد'; again.onclick = () => { sessionId = null; render(); };
      app.appendChild(again);
    }

    document.addEventListener('DOMContentLoaded', render);
  </script>
</head>
<body>
  <h1>ATLAM | تقييم المصنع وفق SIRI (تجريبي)</h1>
  <div id="app"></div>
</body>
</html>
